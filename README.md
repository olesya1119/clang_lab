# Преобразование и анализ кода с использованием Clang и LLVM

<b>Цель работы:</b> Познакомиться с инструментами Clang и LLVM, научиться собирать AST и IR-промежуточное представление кода на C/C++, а также извлекать базовую информацию о программе.

## Задачи: 

1. Установить Clang и LLVM;

2. Скомпилировать простой C-файл с использованием clang и получить его: абстрактное синтаксическое дерево (AST), промежуточное представление LLVM IR;

3. Использовать opt для применения базовой комплексной оптимизации (например, О2);

4. Построить граф потока управления (CFG) для оптимизированной программы;

5. Проанализировать результат, сделать выводы и ответить на контрольные вопросы.

## Ход работы
### 1. Установка и подготовка среды

Работа выполнялась в среде Ubuntu 22.04(WSL).

Установлены следующие инструменты:
- `clang` — компилятор языка C/C++;
- `llvm` — инструменты анализа и оптимизации кода;
- `opt` — инструмент для работы с LLVM IR и применения оптимизаций;
- `Graphviz` — инструмент для визуализации кода.  

```bash
sudo dnf install clang llvm graphviz
```


### 2. Исходный код
```C
#include <stdio.h>
int square(int x) {
 return x * x;
}
int main() {
 int a = 5;
 int b = square(a);
 printf("%d\n", b);
 return 0;
}
```

### 3. Получение AST

```bash
clang -Xclang -ast-dump -fsyntax-only main.c
```


### 4. Генерация LLVM IR

```bash
clang -S -emit-llvm main.c -o main.ll
```

### 5. Оптимизация IR


```bash
clang -O0 -S -emit-llvm main.c -o main_O0.ll
```

```bash
clang -O2 -S -emit-llvm main.c -o main_O2.ll
```

**Сравнение (diff):**
```bash
diff main_O0.ll main_O2.ll
```


**Изменения после оптимизации:**
- Функция `square` встроена в `main` (-inline - оптимизация).

- Константа 25 подставлена напрямую (-constprop - оптимизация).

- Удалены `alloca`, `load`, `store` (-mem2reg, dce - оптимизация).

**Вывод:**
Оптимизации значительно упростили код, устранив избыточные операции.

### 6. Граф потока управления программы
**Шаг 1: Генерация CFG:**

```bash
opt -passes=dot-cfg -disable-output lang_lab7_O2.ll
dot -Tpng .main.dot -o cfg_main.png
dot -Tpng .square.dot -o cfg_square.png
```



**Результат:**

- Граф для `main` содержит один блок (после оптимизации).

- Граф для `square` показывает блок с операцией `mul`.

**Вывод:**
CFG наглядно демонстрирует упрощение потока управления после оптимизаций.

### Выводы по работе
- Clang — обеспечивает глубокий статический анализ кода через AST (Abstract Syntax Tree) и IR (Intermediate Representation), позволяя исследовать структуру программы и семантику на разных уровнях абстракции.

- Оптимизации LLVM (уровень -O2) — агрессивно трансформируют промежуточное представление (IR), устраняя мертвый код, сводя вычисления к константам и упрощая графы выражений для повышения эффективности.

- Граф управления потоком (CFG) — визуализирует логику выполнения программы, отображая базовые блоки и переходы между ними, что критично для анализа доминаторов, обнаружения циклов и оптимизации условий.

